<title><%= title %></title>

<div class="page-title">
  <h1>Viewing <%= community.name %></h1>
  <p><strong>Members:</strong> <%= community.members.length %></p>
</div>

<% if (community.coverImage) { %>
  <img src="<%= community.coverImage %>" alt="Community Cover" class="community-cover">
<% } %>

<p><%= community.description %></p>
<p><strong>Owner:</strong> <%= community.owner.username %></p>

<% if (isMember) { %>
<section class="new-post-section">
  <h2>Create a New Post</h2>
  <form action="/communities/<%= community._id %>/posts" method="POST">
    <input type="text" name="title" placeholder="Post title" required><br>
    <textarea name="body" placeholder="What's on your mind?" required></textarea>
    <button type="submit">Post</button>
  </form>
</section>
<% } else { %>
<p><em>Join this community to post updates.</em></p>
<% } %>

<section class="community-posts">
  <h2>Community Feed</h2>
  <% if (posts && posts.length > 0) { %>
  <ul class="post-list">
    <% posts.forEach(post => { %>
    <li class="post">
      <strong><%= post.author?.username || "Unknown" %>:</strong>
      <span><%= post.content %></span>
      <small><%= new Date(post.createdAt).toLocaleString() %></small>
    </li>
    <% }) %>
  </ul>
  <% } else { %>
  <p>No posts yet. Be the first to post!</p>
  <% } %>
</section>

<h3>Members:</h3>
<ul>
  <% community.members.forEach(member => { %>
    <li><%= member.username %></li>
  <% }) %>
</ul>

<% if (isOwner) { %>
  <p><a href="/communities/<%= community._id %>/edit">Edit this community</a></p>
<% } %>

<% if (community.owner._id.toString() !== user._id.toString()) { %>
  <% const isMember = community.members.some(m => m._id.toString() === user._id.toString()); %>
  
  <form action="/communities/<%= community._id %>/<%= isMember ? 'leave' : 'join' %>" method="POST">
    <button type="submit">
      <%= isMember ? "Leave Community" : "Join Community" %>
    </button>
  </form>
<% } %>

<% if (community.members.some(m => m._id.toString() === user._id.toString())) { %>
  <form action="/communities/<%= community._id %>/invite" method="POST">
    <label for="friendId">Invite a friend:</label>
    <select name="friendId" id="friendId">
      <% friends.forEach(friend => { %>
        <% const alreadyMember = community.members.some(m => m._id.toString() === friend._id.toString()); %>
        <% if (!alreadyMember) { %>
          <option value="<%= friend._id %>"><%= friend.username %></option>
        <% } %>
      <% }) %>
    </select>
    <button type="submit">Send Invite</button>
  </form>
<% } %>

<p><a href="/communities">‚Üê Back to My Communities</a></p>
