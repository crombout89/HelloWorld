<h1>ğŸ”” Your Notifications</h1>

<form action="/notifications/mark-all-read" method="POST">
  <button type="submit">ğŸ“­ Mark All as Read</button>
</form>

<% if (notifications.length === 0) { %>
<p>No notifications yet!</p>
<% } else { %>
<ul>
  <% notifications.forEach(note => { %>
  <li style="margin-bottom: 1.5rem;">
    <p><%= note.message %></p>

    <!-- Only show if not already read -->
    <% if (!note.read) { %>
    <form method="POST" action="/notifications/read/<%= note._id %>" style="display:inline;">
      <button type="submit">ğŸ‘ï¸ Mark as Read</button>
    </form>
    <% } %>

    <!-- âœ… FRIEND REQUEST (accept or decline) -->
    <% if (note.meta?.type === "friend_request") { %>
    <form action="/friends/respond/<%= note.meta.requestId %>" method="POST" style="display:inline;">
      <input type="hidden" name="decision" value="accept" />
      <input type="hidden" name="notificationId" value="<%= note._id %>" />
      <button>âœ… Accept</button>
    </form>
    <form action="/friends/respond/<%= note.meta.requestId %>" method="POST" style="display:inline;">
      <input type="hidden" name="decision" value="decline" />
      <input type="hidden" name="notificationId" value="<%= note._id %>" />
      <button>âŒ Decline</button>
    </form>

    <!-- ğŸ“¥ JOIN REQUEST (link to manage page for owner) -->
    <% } else if (note.meta?.type === "join_request") { %>
    <a href="/communities/<%= note.meta.communityId %>/manage">ğŸ”§ Manage Request</a>

    <!-- ğŸ“¬ JOIN RESPONSE (user got accepted or rejected) -->
    <% } else if (note.meta?.type === "join_response") { %>
    <% if (note.meta.status === "accept") { %>
    <p>ğŸ‰ You were approved to join!</p>
    <% } else { %>
    <p>âŒ Your join request was declined.</p>
    <% } %>
    <a href="/communities/<%= note.meta.communityId %>">View Community</a>

    <!-- ğŸ¤ FRIEND ACCEPTED CONFIRMATION (no action) -->
    <% } else if (note.meta?.type === "friend_accept") { %>
    <!-- passive confirmation only -->

    <!-- ğŸ“¨ COMMUNITY INVITE -->
    <% } else if (note.meta?.type === "community_invite") { %>
    <a href="<%= note.link %>" class="btn">ğŸ˜ï¸ View Community</a>

    <!-- ğŸ“¨ EVENT INVITE -->
    <% if (isHost && friends && friends.length > 0) { %>
    <h3>Invite a Friend</h3>
    <form action="/events/<%= event._id %>/invite" method="POST">
      <label for="userId">Select a friend to invite:</label>
      <select name="userId" id="userId" required>
        <% friends.forEach(friend => { %>
        <% const alreadyInvited = event.invitees?.some(id => id.toString() === friend._id.toString()); %>
        <% if (!alreadyInvited) { %>
        <option value="<%= friend._id %>"><%= friend.username %></option>
        <% } %>
        <% }) %>
      </select>
      <button type="submit">Send Invite</button>
    </form>
    <% } %>

    <!-- ğŸ“ WALL POST -->
    <% } else if (note.meta?.type === "wall_post") { %>
    <a href="<%= note.link %>">ğŸ“ View Wall</a>

    <!-- ğŸ”— DEFAULT LINK FALLBACK -->
    <% } else if (note.link) { %>
    <a href="<%= note.link %>">View</a>
    <% } %>
  </li>
  <% }) %>
</ul>
<% } %>