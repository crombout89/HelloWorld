<link rel="stylesheet" href="/css/events.css">

<h2>
  <%= title %>
</h2>

<div class="events-grid">
  <% createdEvents.forEach(event=> { %>
  <div class="event-card">
    <h3>
      <%= event.title %>
    </h3>
    <p class="meta">Members: <%= event.attendees.length %>
    </p>
    <p class="desc">
      <%= (event.description||'').substring(0,100) %>
      <% if ((event.description||'').length>100) { %>…<% } %>
    </p>
    <div class="actions">
      <a href="/events/<%= event._id %>" class="btn view">View</a>
    </div>
  </div>
  <% }) %>

  <% attendingEvents.forEach(event=> { %>
  <div class="event-card attending">
    <h3>
      <%= event.title %>
    </h3>
    <p class="meta">Members: <%= event.attendees.length %>
    </p>
    <p class="desc">
      <%= (event.description||'').substring(0,100) %>
      <% if ((event.description||'').length>100) { %>…<% } %>
    </p>
    <div class="actions">
      <a href="/events/<%= event._id %>" class="btn view">View</a>
    </div>
  </div>
  <% }) %>

  <% if (!createdEvents.length && !attendingEvents.length) { %>
  <p class="no-events">No events yet. Create one!</p>
  <% } %>
</div>

<!-- Trigger Button -->
<button id="create-event-btn">Create an Event</button>

<!-- Inline JS for modal logic -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("global-modal");
    const openBtn = document.getElementById("create-event-btn");

    if (modal && openBtn) {
      openBtn.addEventListener("click", async () => {
        modal.style.display = "flex";
        modal.innerHTML = `<div style="padding: 2rem; background: white; border-radius: 10px;">Loading...</div>`;

        try {
          const res = await fetch("/events/new");
          const html = await res.text();
          modal.innerHTML = `
            <div style="padding: 2rem; background: white; border-radius: 10px; position: relative;">
              <button id="modal-close" style="position: absolute; top: 1rem; right: 1rem;">✖</button>
              ${html}
            </div>
          `;
          document.getElementById("modal-close").addEventListener("click", () => {
            modal.style.display = "none";
            modal.innerHTML = "";
          });
        } catch (err) {
          modal.innerHTML = "<p>❌ Failed to load form</p>";
          console.error(err);
        }
      });
    } else {
      console.warn("Modal or Create Event button not found.");
    }
  });
</script>

<script src="../js/event-map.js"></script>